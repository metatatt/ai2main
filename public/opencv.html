<!DOCTYPE html>
<html>
<head>
  <title>Icon Tracking</title>
  <style>
    #video {
      display: block;
      margin: 0 auto;
    }
    #canvas {
      display: block;
      margin: 0 auto;
      border: 2px solid black;
    }
  </style>
</head>
<body>
  <video id="video" width="640" height="480" autoplay></video>
  <canvas id="canvas" width="640" height="480" crossOrigin="anonymous"></canvas>

  <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCVReady();" type="text/javascript"></script>
  <script>
    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    let iconImage = new Image();

    // Initialize OpenCV when it's ready
    function onOpenCVReady() {
      // Start the webcam
      startCamera();
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.play();

        // Load the icon image and call the trackIcon function after it's fully loaded
        iconImage.onload = () => {
          trackIcon();
        };
        // Replace 'icon.png' with the path to your icon image
        iconImage.src = './img/target3.jpg';
      } catch (error) {
        console.error("Error accessing webcam: ", error);
      }
    }

    function trackIcon() {
      // Draw the webcam feed to the canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Convert the canvas image to a Mat (OpenCV format)
      let mat = cv.imread(canvas);

      // Convert the icon image to a Mat (OpenCV format)
      let icon = cv.imread(iconImage);

      // Match the icon in the webcam image using Template Matching
      let result = new cv.Mat();
      cv.matchTemplate(mat, icon, result, cv.TM_CCOEFF_NORMED);

      // Find the location of the best match (top-left corner)
      let minMax = cv.minMaxLoc(result);
      let { x, y } = minMax.maxLoc;

      // Draw a rectangle around the detected icon
      let { width, height } = icon.size();
      let color = new cv.Scalar(0, 255, 0); // Green color
      cv.rectangle(mat, { x, y }, { x: x + width, y: y + height }, color, 2);

      // Update the canvas with the annotated image
      cv.imshow(canvas, mat);

      // Release the memory used by the Mats
      mat.delete();
      icon.delete();
      result.delete();

      // Call the trackIcon function again on the next frame
      requestAnimationFrame(trackIcon);
    }
  </script>
</body>
</html>
