<!DOCTYPE html>
<html>
<head>
  <title>Icon Tracking</title>
  <style>
    #video {
      display: block;
      margin: 0 auto;
    }
    #canvas {
      display: block;
      margin: 0 auto;
      border: 2px solid black;
    }
  </style>
</head>
<body>
  <video id="video" width="640" height="480" autoplay></video>
  <canvas id="canvas" width="640" height="480" crossOrigin="anonymous"></canvas>

  <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCVReady();" type="text/javascript"></script>
  <script>
    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    let iconImages = []; // Array to store multiple icon images
    let iconPositions = []; // Array to store the positions of detected icons

    // Initialize OpenCV when it's ready
    function onOpenCVReady() {
      // Start the webcam
      startCamera();
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.play();

        // Load the icon images and call the trackIcons function after they're fully loaded
        let iconImage1 = new Image();
        iconImage1.onload = () => {
          iconImages.push(iconImage1);
          loadNextIconImage();
        };
        iconImage1.src = './img/target4.jpg';

        let iconImage2 = new Image();
        iconImage2.onload = () => {
          iconImages.push(iconImage2);
          loadNextIconImage();
        };
        iconImage2.src = './img/target4.jpg';
      } catch (error) {
        console.error("Error accessing webcam: ", error);
      }
    }

    function loadNextIconImage() {
      if (iconImages.length === 2) {
        // Both icon images have been loaded, start tracking
        trackIcons();
      }
    }

    function trackIcons() {
      // Draw the webcam feed to the canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Convert the canvas image to a Mat (OpenCV format)
      let mat = cv.imread(canvas);

      // Iterate through each icon image and perform Template Matching
      for (let i = 0; i < iconImages.length; i++) {
        let iconImage = iconImages[i];
        let icon = cv.imread(iconImage);

        // Match the icon in the webcam image using Template Matching
        let result = new cv.Mat();
        cv.matchTemplate(mat, icon, result, cv.TM_CCOEFF_NORMED);

        // Find the location of the best match (top-left corner)
        let minMax = cv.minMaxLoc(result);
        let { x, y } = minMax.maxLoc;

        // Draw a rectangle around the detected icon
        let { width, height } = icon.size();
        let color = new cv.Scalar(0, 255, 0); // Green color
        cv.rectangle(mat, { x, y }, { x: x + width, y: y + height }, color, 2);

        // Store the position of the detected icon in the array
        iconPositions[i] = { x, y };

        // Release the memory used by the Mats
        icon.delete();
        result.delete();
      }

      // Update the canvas with the annotated image
      cv.imshow(canvas, mat);

      // Release the memory used by the Mat
      mat.delete();

      // Call the trackIcons function again on the next frame
      requestAnimationFrame(trackIcons);
    }
  </script>
</body>
</html>
